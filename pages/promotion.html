<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Influencer</title>
    <!--css-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/demo_cms_web/CSS/style.css"/> <!-- Đường dẫn đến style.css -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex">
        <!-- Sidebar -->
        <div class="w-1/6 text-white min-h-screen p-4 sidebar">
            <div class="text-center mb-8">
                <img alt="Petal Pay Logo" class="mx-auto mb-4" height="50" src="/demo_cms_web/CSS/images/logo.png" width="300"/>
            </div>
            <nav>
                <ul>
                    <li class="mb-4 sidebar-item p-2">
                        <a class="flex items-center" href="dashboard.html">
                            <i class="fas fa-tachometer-alt mr-2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="mb-4 sidebar-item p-2" onclick="toggleSubmenu(this)">
                        <a class="flex items-center justify-between" href="#">
                            <span class="flex items-center">
                                <i class="fas fa-chart-line mr-2"></i>
                                Commission
                            </span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <ul class="submenu">
                            <li class="mb-4 submenu-item p-2">
                                <a class="flex items-center" href="reconciliation.html">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Reconciliation
                                </a>
                            </li>
                            <li class="mb-4 submenu-item p-2">
                                <a class="flex items-center" href="payment.html">
                                    <i class="fas fa-credit-card mr-2"></i>
                                    Payment
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="mb-4 sidebar-item p-2">
                        <a class="flex items-center" href="influencer.html">
                            <i class="fas fa-user-friends mr-2"></i>
                            Influencer
                        </a>
                    </li>
                    <li class="mb-4 sidebar-item p-2">
                        <a class="flex items-center" href="product.html">
                            <i class="fas fa-box mr-2"></i>
                            Product
                        </a>
                    </li>
                    <li class="mb-4 sidebar-item p-2">
                        <a class="flex items-center" onclick="showContent('promotion')">
                            <i class="fas fa-bullhorn mr-2"></i>
                            Promotion
                        </a>
                    </li>
                    <li class="mb-4 sidebar-item p-2">
                        <a class="flex items-center" href="system.html">
                            <i class="fas fa-cogs mr-2"></i>
                            System
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        <!--Main Content-->
        <div class="w-5/6 p-8 main-content bg-[#F5EDED]" id="promotion">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold text-[#A37C6B]">Promotion</h2>
                <div class="flex items-center">
                    <img alt="User Avatar" class="rounded-full mr-2" height="40" src="https://storage.googleapis.com/a1aa/image/UOcGYnK8ITsCcPmZuC4lFSmnbn5mPsjOFi581rmF9Lw.jpg" width="40"/>
                    <i class="fas fa-bell text-xl"></i>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div class="bg-white p-4 rounded shadow flex items-center" style="border-radius: 8px;">
                    <i class="fas fa-user-friends text-3xl text-[#A37C6B] mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-[#A37C6B]">Total Campaigns</h3>
                        <p class="text-2xl font-bold totalCampaigns">0</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded shadow flex items-center" style="border-radius: 8px;">
                    <i class="fas fa-shopping-cart text-3xl text-[#A37C6B] mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-[#A37C6B]">Total Influencers</h3>
                        <p class="text-2xl font-bold totalInfluencers">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded shadow" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center justify-start mb-2 flex-wrap">
                    <div class="flex flex-col mr-2 w-full md:w-auto">
                        <label class="text-[#A37C6B] mb-1">Search</label>
                        <input class="border rounded p-2" placeholder="Search" type="text" style="border-radius: 8px; width: 430px;"/>
                    </div>
                    <div class="flex flex-col mr-2 w-full md:w-auto">
                        <label class="text-[#A37C6B] mb-1">Status</label>
                        <select class="border rounded p-2" style="border-radius: 8px; width: 170px;">
                            <option>Ongoing</option>
                            <option>Upcoming</option>
                            <option>Ended</option>
                        </select>
                        <span class="absolute right-2 top-2 pointer-events-none" style="right: 50px;"> <!-- Căn chỉnh khoảng cách -->
                            <i class="fas fa-chevron-down"></i>
                        </span>
                    </div>
                    <div class="flex flex-col mr-2 w-full md:w-auto">
                        <label class="text-[#A37C6B] mb-1">Time Range</label>
                        <div class="flex space-x-2">
                            <input class="border rounded p-2" type="date" id="startDate" style="border-radius: 8px;"/>
                            <input class="border rounded p-2" type="date" id="endDate" style="border-radius: 8px;"/>
                        </div>
                    </div>
                    <div class="flex flex-row mr-2 w-full md:w-auto"> <!-- Thay đổi để căn chỉnh với các filter -->
                        <button class="bg-[#F5EDED] text-[#A37C6B] p-2 rounded flex items-center" style="border-radius: 8px; width: 100px; height: 36px; margin-right: 5px;" onclick="openDrawer()">
                            <i class="fas fa-file-import mr-2"></i> Import
                        </button>
                        <button class="bg-[#F5EDED] text-[#A37C6B] p-2 rounded flex items-center" style="border-radius: 8px; width: 100px; height: 36px;" onclick="exportToExcel()">
                            <i class="fas fa-file-export mr-2"></i> Export
                        </button>
                    </div>                    
                </div>
                    <div class="table-container"  style="max-height: 280px; overflow-y: auto;">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-[#F5EDED]">
                                    <th class="border-b p-2 text-[#A37C6B]">Campaign ID</th>
                                    <th class="border-b p-2 text-[#A37C6B]">Campaign name</th>
                                    <th class="border-b p-2 text-[#A37C6B]">Campaign duration</th>
                                    <th class="border-b p-2 text-[#A37C6B]">Total Influencers</th>
                                    <th class="border-b p-2 text-[#A37C6B]">Items sold</th>
                                    <th class="border-b p-2 text-[#A37C6B]">Total Affiliate GMV</th>
                                    <th class="border-b p-2 text-[#A37C6B]">Total Creator CMS</th>
                                    <th class="border-b p-2 text-[#A37C6B]">Total TAP CMS</th>
                                    <th class="border-b p-2 text-[#A37C6B]">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="promtionTable">
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end items-center mt-4">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination">
                                <li class="page-item">
                                    <a class="page-link" href="#" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    <!--Edit Modal-->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-1/3">
            <h2 class="text-xl font-bold mb-4">Edit Promotion Information</h2>
            <form id="editForm">
                <div class="mb-4">
                    <label class="block text-gray-700">Campaign ID</label>
                    <input class="border border-gray-300 rounded p-2 w-full" id="campaignID" type="text" placeholder="Enter your Campaign ID" required/>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">Campaign name</label>
                    <input class="border border-gray-300 rounded p-2 w-full" id="campaignName" type="text" placeholder="Enter your Campaign Name" required/>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">Start Time</label>
                    <input class="border border-gray-300 rounded p-2 w-full" id="startDate" type="date"/>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">End Time</label>
                    <input class="border border-gray-300 rounded p-2 w-full" id="endDate" type="date"/>
                </div>
                <div class="flex justify-end">
                    <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded mr-2" type="button" onclick="closeEditModal()">Cancel</button>
                    <button class="bg-blue-500 text-white px-4 py-2 rounded" type="submit">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!--Delete Modal-->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-1/3">
            <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
            <p class="mb-4">Are you sure you want to delete this promotion?</p>
            <div class="flex justify-end">
                <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded mr-2" type="button" onclick="closeDeleteModal()">Cancel</button>
                <button class="bg-red-500 text-white px-4 py-2 rounded" type="button" onclick="deletePromotion()">Delete</button>
            </div>
        </div>
    </div>
    <div id="overlay" class="overlay" style="display: none;"></div>
    <div id="drawer" class="drawer" style="display: none;">
        <div class="max-w-4xl mx-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center" onclick="closeDrawer()">
                    <i class="fas fa-arrow-left text-gray-600"></i>
                    <span class="ml-2 text-gray-600">Đóng</span>
                </div>
                <button class="bg-[#A37C6B] text-white px-4 py-2 rounded" onclick="confirmUpload()">Xác nhận</button>
            </div>
            <h1 class="text-xl font-semibold mb-4">Tải lên dữ liệu</h1>
            <p class="text-gray-600 mb-2">Vui lòng tải lên file Excel hoặc CSV theo mẫu.</p>
            <div class="border border-gray-300 rounded-lg p-6 flex items-center justify-center">
                <div class="text-center">
                    <label for="file-upload" class="bg-gray-200 rounded-full p-4 inline-block mb-2 cursor-pointer">
                        <i class="fas fa-upload text-gray-600 text-2xl"></i>
                    </label>
                    <p class="text-gray-600 font-semibold">Nhấn tải lên file danh sách</p>
                    <p class="text-gray-500">File dữ liệu (.xlsx, .xls hoặc .csv)</p>
                    <input id="file-upload" type="file" accept=".xlsx, .xls, .csv" class="hidden" onchange="uploadFile()" />
                    
                    <!-- Phần hiển thị tên file -->
                    <div id="file-name-display" class="mt-2 text-gray-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPage = 1; // Variable to track the current page
    let selectedFile = null; // Global variable to store the selected file
    
    function toggleSubmenu(element) {
        element.classList.toggle('active');
    }

    function showContent(contentId) {
        document.querySelectorAll('.main-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(contentId).classList.add('active');
    }
    function uploadFile() {
        const fileInput = document.getElementById('file-upload');
        selectedFile = fileInput.files[0];

        if (!selectedFile) {
            alert('Vui lòng chọn file để tải lên.');
            return;
        }

        // Display the file name and icon
        const fileNameDisplay = document.getElementById('file-name-display');
        fileNameDisplay.innerHTML = `
            <i class="fas fa-file-excel text-green-500"></i> 
            ${selectedFile.name}
        `;
    }

    function confirmUpload() {
        if (!selectedFile) {
            alert('Vui lòng chọn file để tải lên.');
            return;
        }

        // Create a FormData object to send the file
        const formData = new FormData();
        formData.append('file', selectedFile); // Add the file to FormData

        // Send a POST request to the /upload endpoint
        fetch('/demo_cms_web/upload_promotion', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                alert('Tải lên thành công!'); // Show success message
                loadData(); // Refresh data in the table
                closeDrawer(); // Close the drawer after successful upload
            } else {
                alert('Tải lên thất bại!'); // Show failure message
            }
        })
        .catch(error => {
            console.error('Lỗi:', error); // Log the error to console
            alert('Đã xảy ra lỗi khi tải lên.'); // Show error message
        });
    }

    function loadData() {
        fetch('/demo_cms_web/Data_promo')
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text); });
            }
            return response.json();
        })
        .then(result => {
            console.log(result); // Check the data
            const tableBody = document.getElementById('promtionTable');
            tableBody.innerHTML = ''; // Clear existing data

            // Initialize variables to store summary data
            const campaignIds = new Set(); // To store unique Campaign IDs
            let totalInfluencers = 0;
    
            result.data.forEach(item => {
                const row = `<tr>
                    <td class="border-b p-2">${item['Campaign ID'] || ''}</td>
                    <td class="border-b p-2">${item['Campaign_Name'] || ''}</td>
                    <td class="border-b p-2">${item['Campaign_Duration'] || ''}</td>
                    <td class="border-b p-2">${item['Total_Influencers'] || 0}</td>
                    <td class="border-b p-2">${item['Total_Items_Sold'] || 0}</td>
                    <td class="border-b p-2">${item['Total_Affiliate_GMV'] || 0}</td>
                    <td class="border-b p-2">${item['Total_Creator_CMS'] || 0}</td>
                    <td class="border-b p-2">${item['Total_TAP_CMS'] || 0}</td>
                    <td class="border-b p-2">
                        <button class="text-blue-500" onclick="openEditModal('${item['Campaign_Name']}', '${item['Campaign_Duration']}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500" onclick="openDeleteModal(this)"><i class="fas fa-trash"></i></button>
                </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row); // Add new row to the table

                // Collect unique Campaign IDs
                campaignIds.add(item['Campaign ID']);
                // Sum Influencers
                totalInfluencers += parseInt(item['Total_Influencers']) || 0;
            });

            // Update summary cards
            document.querySelector('.totalCampaigns').innerText = campaignIds.size; // Count of unique Campaign IDs
            document.querySelector('.totalInfluencers').innerText = totalInfluencers; // Total Influencers
    
            // Update pagination
            updatePagination(result.total_pages);
        })
        .catch(error => {
            console.error('Error fetching data:', error); // Log the error
            alert('Failed to load data: ' + error.message); // Show an alert with error message
        });
    }

    function changePage(page) {
        if (page < 1 || page > totalPages) return; // Validate page number
        currentPage = page; // Update the current page
        loadData(currentPage); // Load data for the new page
    }

    function updatePagination(totalPages) {
        const paginationContainer = document.querySelector('.pagination');
        paginationContainer.innerHTML = ''; // Clear old content
    
        const pageCount = 3; // Number of pages to show
        let startPage = Math.max(1, currentPage - Math.floor(pageCount / 2));
        let endPage = Math.min(totalPages, startPage + pageCount - 1);
    
        // Adjust startPage if endPage is at totalPages
        if (endPage === totalPages) {
            startPage = Math.max(1, totalPages - pageCount + 1);
        }
    
        // Create Previous button
        const prevButton = document.createElement('li');
        prevButton.className = 'page-item';
        prevButton.innerHTML = `<a class="page-link" href="#" aria-label="Previous" onclick="changePage(currentPage - 1)"><span aria-hidden="true">&laquo;</span></a>`;
        if (currentPage === 1) {
            prevButton.classList.add('disabled'); // Disable Previous button if on first page
        }
        paginationContainer.appendChild(prevButton);
    
        // Create page buttons
        for (let i = startPage; i <= endPage; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = 'page-item';
            pageItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            if (i === currentPage) {
                pageItem.classList.add('active'); // Highlight current page
            }
            paginationContainer.appendChild(pageItem);
        }
    
        // Create Next button
        const nextButton = document.createElement('li');
        nextButton.className = 'page-item';
        nextButton.innerHTML = `<a class="page-link" href="#" aria-label="Next" onclick="changePage(currentPage + 1)"><span aria-hidden="true">&raquo;</span></a>`;
        if (currentPage === totalPages) {
            nextButton.classList.add('disabled'); // Disable Next button if on last page
        }
        paginationContainer.appendChild(nextButton);
    }

    // Load data when the page is loaded
    window.onload = loadData;

    function openDrawer() {
        document.getElementById('overlay').style.display = 'block'; // Hiện overlay
        document.getElementById('drawer').style.display = 'block'; // Hiện drawer
        setTimeout(() => {
            document.getElementById('drawer').classList.add('open');
        }, 10);
    }
    function exportToExcel() {
        // Lấy bảng dữ liệu từ id
        const table = document.getElementById('promotionTable');
        const data = [];
        
        // Lấy các tiêu đề cột, bỏ qua cột "Actions"
        const headers = Array.from(table.closest('table').querySelectorAll('thead th'))
            .slice(0, -1) // Bỏ cột cuối
            .map(th => th.innerText);
        data.push(headers);
    
        // Lấy dữ liệu trong các hàng, bỏ cột "Actions"
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const rowData = Array.from(row.querySelectorAll('td')).slice(0, -1) // Bỏ cột cuối
                .map(td => td.innerText);
            data.push(rowData);
        });
    
        // Tạo workbook
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    
        // Xuất file
        XLSX.writeFile(wb, 'promotion.xlsx');
    }
    function openDrawer() {
        document.getElementById('overlay').style.display = 'block'; // Hiện overlay
        document.getElementById('drawer').style.display = 'block'; // Hiện drawer
        setTimeout(() => {
            document.getElementById('drawer').classList.add('open');
        }, 10);
    }
    function closeDrawer() {
        document.getElementById('drawer').classList.remove('open');
        setTimeout(() => {
            document.getElementById('drawer').style.display = 'none'; // Ẩn drawer
            document.getElementById('overlay').style.display = 'none'; // Ẩn overlay
        }, 300);
    }
    function openEditModal() {
        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function openDeleteModal(button) {
        document.getElementById('deleteModal').classList.remove('hidden');
        // Store the row to be deleted
        document.getElementById('deleteModal').dataset.row = button.closest('tr').rowIndex;
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
    }

    function deletePromotion() {
        const rowIndex = document.getElementById('deleteModal').dataset.row;
        document.getElementById('promtionTable').deleteRow(rowIndex - 1);
        closeDeleteModal();
    }

    document.getElementById('editForm').addEventListener('submit', function (e) {
        e.preventDefault();
        // Get the values from the form
        const commissionRate = document.getElementById('commissionRate').value;
        const effectiveDate = document.getElementById('effectiveDate').value;

        // Update the table or perform any other actions needed
        console.log('Commission Rate:', commissionRate);
        console.log('Effective Date:', effectiveDate);

        // Close the modal
        closeEditModal();
    });
</script>  
</body>
</html>   